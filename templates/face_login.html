<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>人脸登录</title>
    <link href="/static/css/layui.css" rel="stylesheet">
</head>
<body>
    <ul class="layui-nav">
        <li class="layui-nav-item">
            <img alt="50x50" src="/static/img/logo-big-w.png" width=100% height=30pt />
        </li>
        <li class="layui-nav-item">
            <a href="">您好，请登录</a>
        </li>
    </ul>

    <div id='content' style="padding: 10pt 550px 10pt 550px;">
        <h1 style="text-align: center; padding: 20pt;">人脸登录</h1>
        
        <!-- 人脸识别登录表单 -->
        <form id="face-login-form" class="layui-form" method="post" enctype="multipart/form-data">
            {% csrf_token %}
            
            <!-- 上传照片用于人脸识别 -->
            <div class="layui-form-item" style="padding: 10pt;">
                <label class="layui-form-label">上传照片</label>
                <div class="layui-input-block">
                    <input type="file" name="profile_picture" accept="image/*" required><br>
                </div>
            </div>
            
            <!-- 提交按钮 -->
            <div class="layui-form-item" style="padding: 10pt;">
                <div class="layui-input-block">
                    <button type="submit" class="layui-btn" lay-submit lay-filter="demo1">人脸登录</button>
                    <a href="/register" style="color: #16baaa; padding: 5px">立即注册</a>
                </div>
            </div>
        </form>
    </div>

    <script src="/static/js/layui.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
        $(document).ready(function() {
            // 监听表单提交事件
            $('#face-login-form').on('submit', function(e) {
                e.preventDefault(); // 阻止表单默认提交行为

                // 创建 FormData 对象以处理文件上传
                var formData = new FormData(this); // this 指的是表单对象

                $.ajax({
                    type: 'POST',
                    url: '/face/',  // Django 处理人脸登录的 URL
                    data: formData,
                    contentType: false,  // 让 jQuery 处理 multipart/form-data
                    processData: false,  // 不处理数据，让浏览器处理文件传输
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}'  // Django 的 CSRF 令牌
                    },
                    success: function(response) {
                        if (response.status === 'success') {
                            alert(response.message);  // 显示登录成功消息
                            setTimeout(function() {
                                window.location.href = response.redirect_url;  // 3秒后跳转到重定向 URL
                            }, 3000); // 延迟3秒
                        } else {
                            alert('登录失败：' + response.message);  // 显示登录失败消息
                        }
                    },
                    error: function() {
                        alert('请求失败，请稍后重试。');
                    }
                });
            });
        });
    </script>

</body>
</html>
